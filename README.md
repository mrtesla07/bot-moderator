# bot-moderator

Многофункциональный Telegram-бот для модерации чатов на базе aiogram. Поддерживает антифлуд, капчу, репутацию, whitelists/blacklists и управляется через современную веб-админку FastAPI‑Admin.

## Что уже умеет
- антифлуд с настраиваемыми лимитами и наказаниями (mute / ban / delete);
- фильтрация мата и стоп-слов, отдельные списки для premium-чатов;
- контроль ссылок (разрешённые/запрещённые домены, доверенные пользователи);
- приветствия, капча, ночной режим, тихий режим, защита от рейдов;
- репутация, предупреждения, логи действий модерации;
- веб-админка на FastAPI-Admin: CRUD по ключевым таблицам, редактирование JSON-настроек без перезапуска бота.

## Требования
- Python 3.11+
- Redis (требуется для сессий FastAPI-Admin)
- SQLite по умолчанию (можно заменить на PostgreSQL/MySQL)
- Git, Docker + Docker Compose (для контейнерного запуска)

## Быстрый старт (локально)
```bash
python -m venv .venv
.venv\Scripts\activate            # Windows
# source .venv/bin/activate        # Linux/Mac
pip install -r requirements.txt
cp .env.example .env
# пропишите реальные токены/параметры в .env
python -m bot_moderator.main
```
После старта:
1. В консоли увидите лог о запуске веб-сервера на `http://localhost:8080/`.
2. Перейдите по адресу браузером.
3. Авторизуйтесь, используя `ADMIN_USERNAME` и `ADMIN_PASSWORD` из `.env` (по умолчанию admin / change-me).

## Запуск в Docker
```bash
docker compose up --build -d
```
Что происходит:
- сервис `bot` собирает образ приложения, подхватывает `.env` и монтирует `./data` внутрь контейнера;
- сервис `redis` поднимает Redis 7 и сохраняет данные в `./data/redis`;
- порт 8080 пробрасывается наружу, поэтому админка доступна по `http://localhost:8080/`.

Перед запуском убедитесь, что папка `./data` существует и доступна для записи (на Linux/Mac: `mkdir -p data data/redis && chmod 775 data data/redis`).

Остановка и просмотр логов:
```bash
docker compose logs -f bot
docker compose down
```

## Переменные окружения (.env)
| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `BOT_TOKEN` | Токен Telegram-бота | — |
| `DATABASE_URL` | URL SQLModel (SQLite/PosgreSQL/MySQL). Для SQLite путь относительно корня проекта. | `sqlite+aiosqlite:///./data/moderator.db` |
| `LOG_LEVEL` | Уровень логирования (`DEBUG`, `INFO`, …) | `INFO` |
| `DEFAULT_TIMEZONE` | Таймзона по умолчанию | `Europe/Moscow` |
| `REPORT_CHAT_ID` | ID чата для репортов | пусто |
| `WEB_ENABLED` | Включать ли веб-админку | `true` |
| `WEB_HOST` / `WEB_PORT` | Хост и порт FastAPI | `0.0.0.0` / `8080` |
| `ADMIN_USERNAME` | Логин администратора FastAPI-Admin | `admin` |
| `ADMIN_PASSWORD` | Пароль администратора (поменяйте на свой!) | `change-me` |
| `ADMIN_REDIS_URL` | URL Redis для сессий админки | `redis://localhost:6379/0` |
| `ADMIN_LOGO_URL` | Опциональный логотип на странице логина | пусто |
| `ADMIN_DEFAULT_LOCALE` | Локаль админки (`ru_RU` или `en_US`) | `ru_RU` |
| `ADMIN_DATABASE_URL` | Отдельный URL БД для FastAPI-Admin (если нужен отдельный источник). Иначе используется `DATABASE_URL`. | пусто |

## Панель администратора
- Адрес: `http://localhost:8080/` (или ваш хост/порт).
- Авторизация cookie-базированная, сессии хранятся в Redis.
- Доступные разделы: чаты, пользователи, баны, логи действий, капча, заявки, администраторы.
- Настройки чатов (`settings`) редактируются через JSON-форму: изменения сразу сохраняются в БД.
- При первом запуске автоматически создаётся пользователь с логином/паролем из `.env`. После входа сразу смените пароль.

Если вы хотите использовать внешний Redis, пропишите `ADMIN_REDIS_URL=redis://<host>:<port>/<db>` и убедитесь, что сервис доступен.

## Структура проекта
```
bot_moderator/
  core/            # точка входа приложения, настройка DI и сервисов
  data/            # слой доступа к данным (SQLModel + AsyncSession)
  handlers/        # aiogram-хендлеры (команды, сообщения, коллбеки)
  models/          # Pydantic-модели и SQLModel-сущности
  services/        # бизнес-логика (антифлуд, чат-сервис, капча и т.д.)
  utils/           # вспомогательные функции
  web/             # админка (FastAPI-Admin, ресурсы и модели)
  tests/           # минимальные тесты
```

## Полезные команды
```bash
ruff check .                 # Быстрый линтинг
pytest                       # Запуск тестов
python -m compileall bot_moderator  # Проверка, что модули компилируются
```

## Типичные проблемы
- **Бот не стартует, пишет “Redis connection error”** — проверьте `ADMIN_REDIS_URL` и что Redis запущен.
- **Телеграм не принимает токен** — убедитесь, что `BOT_TOKEN` верен и не пустой.
- **Админка недоступна** — проверьте, что `WEB_ENABLED=true`, порт 8080 не занят и контейнер/процесс запущен.
- **База не создаётся** — для SQLite обязательно наличие папки `./data`; для других СУБД проверьте права доступа и строку подключения.

Готово! После настройки и запуска бот будет модерировать ваши чаты, а все параметры можно менять через удобную веб-панель.

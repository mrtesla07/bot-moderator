# bot-moderator

Многофункциональный Telegram-бот для модерации чатов. Собирает идеи из гайда DeFensy: автоматизирует антиспам, следит за порядком и даёт удобную панель управления в браузере.

## Возможности
- антифлуд с гибкими лимитами и действиями (mute / ban / delete);
- фильтры мата и стоп-слов (поддержка премиум-режима с дополнительным списком);
- блокировка и разрешение ссылок, доверенные пользователи, белые/чёрные списки доменов;
- капча и приветствие для новых участников, фильтрация имён, защита от рейдов;
- репутация (+rep / -rep), предупреждения, отчёты о срабатываниях правил;
- ночной и тихий режимы, автоудаление служебных уведомлений;
- веб-панель на FastAPI для быстрого редактирования настроек.

## Структура проекта
```
bot_moderator/
  core/        # запуск бота, действия и результаты модерации
  data/        # доступ к базе через SQLModel
  handlers/    # роутеры aiogram (сообщения, колбэки, админ-команды)
  models/      # pydantic-настройки и ORM-сущности
  services/    # бизнес-логика: модерация, чаты, пользователи, капча
  utils/       # утилиты (работа со временем и пр.)
  web/         # FastAPI-приложение и шаблоны панели управления
```

## Быстрый старт (локально)
```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
cp .env.example .env  # отредактируйте BOT_TOKEN, DATABASE_URL, REPORT_CHAT_ID, WEB_HOST/PORT
python -m bot_moderator.main
```
> После запуска бот сам поднимет веб-панель. По умолчанию она доступна на `http://localhost:8080/`.

## Веб-панель
- список чатов, зарегистрированных в базе (`/`);
- экран настроек чата: тариф (free/premium), антифлуд, стоп-слова, капча, тихий режим, приветствие, отчётный чат;
- все изменения сохраняются через `ChatService` и применяются без перезапуска бота.

### Переменные окружения
| Переменная | Назначение | Значение по умолчанию |
|------------|------------|------------------------|
| `BOT_TOKEN` | токен Telegram-бота | — |
| `DATABASE_URL` | строка подключения SQLModel | `sqlite+aiosqlite:///./data/moderator.db` |
| `WEB_ENABLED` | запуск веб-панели | `true` |
| `WEB_HOST` | адрес, на котором слушает панель | `0.0.0.0` |
| `WEB_PORT` | порт панели | `8080` |

## Основные команды администратора
| Команда | Описание |
|---------|----------|
| `/dfsync` | синхронизировать чат и админов с ботом |
| `/dfaddwl <id/@user>` / `/dfdelwl` | управлять белым списком ссылок |
| `/dfwhitelist` | вывести текущий whitelist |
| `/trust` (reply или ID) | выдать/снять доверенный статус |
| `/warn` / `/unwarn` | добавить или снять предупреждение |
| `/setflood <лимит> <сек> <mute|ban|delete>` | настроить антифлуд |
| `/setnightmode <HH:MM> <HH:MM> [delete|mute|off]` | ночной режим |
| `/setrules` / `/rules` | обновить / показать правила |
| `/setwelcome` / `/togglewelcome` | приветствие для новичков |
| `/toggleprofanity`, `/addprofanity` | антимат |
| `/addstopword`, `/delstopword`, `/liststopwords` | список стоп-слов |
| `/setlinkmode <block|allow|trust>` | режим работы ссылок |
| `/setreportchat [chat_id]` | чат для отчётов |
| `/togglesilent` | тихий режим уведомлений |
| `/settimezone <TZ>` | часовой пояс (например `Europe/Moscow`) |
| `/moderatorinfo` | краткая сводка по настройкам |
| `/ping` | проверить доступность бота |

## Запуск в Docker
```bash
docker compose up --build -d
```
- `.env` будет автоматически подхвачен сервисом `bot`;
- база и прочие данные сохраняются в локальной папке `./data` (примонтирована в контейнер);
- убедитесь, что папка `./data` доступна для записи на хосте (например, `mkdir -p data && chmod 775 data`), иначе контейнер не сможет сохранить базу;
- панель доступна по `http://localhost:8080/` (или другому порту, если меняли).

## Разработка и проверки
- Компиляция модулей: `python -m compileall bot_moderator`
- Тесты: `pytest` (часть тестов пропускается, если нет дополнительных зависимостей)
- Линтер: `ruff` (конфигурация в `pyproject.toml`)

## План развития
- авто-закрытие комментариев и перенос настроек между чатами;
- поддержка PostgreSQL / Redis в качестве backend-хранилища;
- расширение веб-панели (live-обновления, отдельные страницы для фильтров, статистика);
- интеграция с внешними сервисами уведомлений.

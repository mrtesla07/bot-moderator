# bot-moderator

Многофункциональный Telegram-бот модерации на базе aiogram. Поддерживает антифлуд, фильтры стоп-слов, репутацию, whitelists/blacklists и современную веб-админку FastAPI-Admin. Новые возможности — автоматическое закрытие обсуждений и защита первых комментариев к постам каналов.

## Что умеет
- антифлуд с гибкими лимитами и наказаниями (mute / ban / delete);
- фильтры мата и стоп-слов (несколько списков, разные действия);
- контроль ссылок: белые/чёрные списки, доверенные пользователи;
- приветствие, капча, анти-рейд, фильтрация вступающих, система репутации;
- веб-админка FastAPI-Admin: CRUD по чатам, пользователям, банам, логам, заявкам, администраторам;
- защита первых комментариев и автозакрытие обсуждений по ключевым словам в постах канала.

## Требования
- Python 3.11+
- Redis (используется FastAPI-Admin для сессий)
- SQLite по умолчанию (можно переключить на PostgreSQL / MySQL)
- Git, Docker и Docker Compose, если запускаете в контейнерах

## Быстрый старт (локально)
```bash
python -m venv .venv
.venv\Scripts\activate            # Windows
# source .venv/bin/activate        # Linux / macOS
pip install -r requirements.txt
cp .env.example .env               # заполните реальные значения
python -m bot_moderator.main
```
После запуска:
1. В терминале увидите адрес веб-интерфейса — по умолчанию `http://localhost:8080/`.
2. Откройте URL в браузере.
3. Авторизуйтесь логином `ADMIN_USERNAME` и паролем `ADMIN_PASSWORD` из `.env` (по умолчанию admin / change-me — смените сразу).

## Запуск в Docker
```bash
docker compose up --build -d
```
Что делает compose:
- сервис `bot` собирает образ, монтирует `./data`, подхватывает `.env`;
- сервис `redis` поднимает Redis 7 и сохраняет данные в `./data/redis`;
- порт 8080 пробрасывается наружу, админка доступна по `http://localhost:8080/`.

Перед запуском создайте папки `./data` и `./data/redis`, выдайте права на запись (Linux/macOS: `mkdir -p data data/redis && chmod 775 data data/redis`).

Просмотр логов и остановка:
```bash
docker compose logs -f bot
docker compose down
```

## Переменные окружения
| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `BOT_TOKEN` | Токен Telegram-бота | — |
| `DATABASE_URL` | DSN для SQLModel (SQLite / PostgreSQL / MySQL) | `sqlite+aiosqlite:///./data/moderator.db` |
| `LOG_LEVEL` | Уровень логирования (`DEBUG`, `INFO`, …) | `INFO` |
| `DEFAULT_TIMEZONE` | Таймзона по умолчанию | `Europe/Moscow` |
| `REPORT_CHAT_ID` | Чат для отчётов бота | пусто |
| `WEB_ENABLED` | Включать ли веб-интерфейс | `true` |
| `WEB_HOST` / `WEB_PORT` | Хост и порт FastAPI | `0.0.0.0` / `8080` |
| `ADMIN_USERNAME` | Логин в FastAPI-Admin | `admin` |
| `ADMIN_PASSWORD` | Пароль (обязательно замените) | `change-me` |
| `ADMIN_REDIS_URL` | Redis для сессий админки | `redis://localhost:6379/0` |
| `ADMIN_LOGO_URL` | Картинка на странице логина | пусто |
| `ADMIN_DEFAULT_LOCALE` | Язык интерфейса админки (`ru_RU` или `en_US`) | `ru_RU` |
| `ADMIN_DATABASE_URL` | Отдельная БД для админки (если нужна) | пусто |

## Веб-админка
- Адрес: `http://localhost:8080/` (или ваш `WEB_HOST/WEB_PORT`).
- Авторизация: cookie-сессии в Redis.
- Разделы: чаты, пользователи, баны, логи действий, ожидающие капчи, заявки, администраторы и т.д.
- Поле `settings` у чата — JSON-конфигурация всех модулей. Изменения применяются сразу после сохранения.

### Как включить защиту постов канала
В нужном чате отредактируйте JSON в админке и добавьте блоки:
```json
"first_comment_guard": {
  "enabled": true,
  "window_seconds": 30
},
"comment_closer": {
  "enabled": true,
  "keywords": ["#nocomments", "закрыть"]
}
```
Пояснения:
- `first_comment_guard` удаляет пользовательские сообщения, которые появляются в ветке поста в течение указанного окна (30 секунд пример).
- `comment_closer` при нахождении ключевых слов вызывает `close_forum_topic` для ветки поста (если есть `message_thread_id`).

Инструкция:
1. FastAPI-Admin → **Чаты** → выбрать чат → поле `settings`.
2. Вставить/отредактировать блоки, сохранить.
3. Перезапуск бота не требуется.

### Опросники / заявки
Параметры `settings.questionnaire` уже есть: вопросы отправляются пользователю при JoinRequest. В расширенной версии планируется авто-одобрение/отклонение (будет добавлено позже).

## Структура проекта
```
bot_moderator/
  core/            # точка входа, инициализация DI и uvicorn
  data/            # работа с БД (SQLModel + AsyncSession)
  handlers/        # aiogram-хендлеры (команды, сообщения, события)
  models/          # Pydantic и SQLModel сущности/настройки
  services/        # бизнес-логика: антифлуд, ссылки, капча, репутация и пр.
  utils/           # утилиты (например, работа со временем)
  web/             # FastAPI-Admin приложения, модели, ресурсы
  tests/           # базовые тесты
```

## Полезные команды
```bash
ruff check .
pytest
python -m compileall bot_moderator
```

## Частые вопросы
- **Redis connection error** — проверьте `ADMIN_REDIS_URL` и что Redis запущен.
- **Бот не принимает токен** — убедитесь, что `BOT_TOKEN` заполнен корректно.
- **Админка не открывается** — `WEB_ENABLED=true`, порт 8080 свободен, контейнер/процесс работает.
- **База не создаётся** — для SQLite нужна папка `./data`; для внешних БД проверьте DSN и права.
- **Защита первых комментариев не срабатывает** — проверьте, что чат связан с каналом, бот назначен админом, а в `settings` есть блоки `first_comment_guard` и `comment_closer` с `enabled: true`.

Бот готов к работе: модерация выполняется автоматически, а настройки меняются через админку без перезапуска.

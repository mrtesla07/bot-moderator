# bot-moderator

Многофункциональный модератор Telegram, реализующий сценарии антиспама и сервисные возможности из гайда по DeFensy. Бот построен на iogram 3, управляется через набор админ-команд и хранит конфигурацию в SQLite.

## Возможности
- **Антифлуд**: контроль количества сообщений, автоматический мут/бан флудеров.
- **Антимат и стоп-слова**: два словаря (основной + дополнительный для подписки), предупреждения и наказания.
- **Фильтрация ссылок**: полный запрет, белые списки доменов и доверенные пользователи.
- **Тихий и ночной режимы**: удаление служебных уведомлений и автоматический мут в указанный интервал.
- **Антиспам по пересылкам**: блокировка пересланных сообщений от внешних источников.
- **Капча и приветствия**: inline-кнопки, ограничение новых участников до прохождения проверки, настраиваемое приветствие.
- **Антирейд**: отслеживание всплесков вступлений с авто-действиями.
- **Фильтрация имён и закрытие входа**: пресеты фильтров, запрет на новые вступления.
- **Система репутации**: команды +rep / -rep, учёт предупреждений.
- **Логи и отчёты**: сводки сработавших правил в отдельный чат.
- **Настройка правил и приветствий**: команды для загрузки текста из чата.

## Быстрый старт
1. Подготовьте виртуальное окружение с Python ≥ 3.11.
   `ash
   python -m venv .venv
   .venv\Scripts\activate
   pip install -r requirements.txt  # или pip install aiogram sqlmodel aiosqlite pydantic-settings
   `
2. Скопируйте .env.example в .env и заполните BOT_TOKEN, при необходимости отредактируйте DATABASE_URL и REPORT_CHAT_ID.
3. Запустите бота:
   `ash
   python -m bot_moderator.main
   `
4. Добавьте бота в группу, выдайте права администратора с возможностью удалять сообщения и блокировать участников, выполните /dfsync.

## Основные команды администратора
| Команда | Назначение |
|---------|------------|
| /dfsync | синхронизация данных группы с ботом. |
| /dfaddwl <id/@user> / /dfdelwl | управление белым списком ссылок. |
| /dfwhitelist | вывести текущий белый список. |
| /trust | выдать/снять доверенный статус пользователю. |
| /warn / /unwarn | управление предупреждениями (по reply). |
| /setflood <лимит> <сек> <mute|ban|delete> | настройка антифлуда. |
| /setnightmode <HH:MM> <HH:MM> [delete|mute|off] | ночной режим. |
| /setrules (reply или текст) / /rules | управление правилами группы. |
| /setwelcome / /togglewelcome | приветствие новых участников. |
| /toggleprofanity, /addprofanity <слово> | антимат. |
| /addstopword <слово> / /delstopword / /liststopwords | стоп-слова. |
| /setlinkmode <block|allow|trust> | режим работы ссылок. |
| /setreportchat [chat_id] | чат для отчётов (reply на пересланный service-message или вручную). |
| /togglesilent | включить/выключить тихий режим уведомлений. |
| /settimezone <TZ> | задать часовой пояс, например Europe/Moscow. |
| /moderatorinfo | краткий отчёт по активным настройкам. |
| /ping | проверка доступности бота. |

Пользовательские команды (/report, +rep, -rep и т.п.) работают в группах; антиспам реагирует автоматически.

## Структура проекта
`
bot_moderator/
  core/              # базовые примитивы (действия, приложение)
  data/              # инфраструктура БД (SQLModel + SQLite/aiosqlite)
  handlers/          # обработчики aiogram (сообщения, колбэки, админ-команды)
  models/            # pydantic и SQLModel модели настроек/состояний
  services/          # бизнес-логика: модерация, чаты, пользователи, капчи
  utils/             # служебные функции (например, работа с часовыми поясами)
`
По умолчанию данные сохраняются в ./data/moderator.db. Настройки чата сериализуются через ChatSettings и могут расширяться без миграций.

## Premium / расширенный функционал
Конфигурация поддерживает признак подписки (settings.subscription.tier) и включает дополнительные опции:
- второй набор стоп-слов;
- расширенные лимиты для белых списков;
- беззвучные уведомления и расширенный ночной режим;
- агрессивные сценарии антинакрутки.

## Разработка и тесты
- Компиляция модулей: python -m compileall bot_moderator
- Тесты: pytest (перед запуском установите зависимости, при отсутствии модулей тесты будут пропущены).
- Стиль кода контролируется uff (см. pyproject.toml).

## Дальнейшие шаги
- Реализовать авто-закрытие комментариев и перенос настроек между группами.
- Подключить внешнее хранилище (PostgreSQL/Redis) для масштабирования.
- Добавить UI-панель/бота-менеджера для настройки без команд.
